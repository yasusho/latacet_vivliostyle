{"version":3,"sources":["../src/core/preview.ts"],"sourcesContent":["import terminalLink from 'terminal-link';\nimport { ViteDevServer } from 'vite';\nimport { blueBright, cyan, dim } from 'yoctocolors';\nimport { setupConfigFromFlags } from '../commands/cli-flags.js';\nimport { loadVivliostyleConfig, warnDeprecatedConfig } from '../config/load.js';\nimport { mergeConfig, mergeInlineConfig } from '../config/merge.js';\nimport { resolveTaskConfig } from '../config/resolve.js';\nimport { ParsedVivliostyleInlineConfig } from '../config/schema.js';\nimport { resolveViteConfig } from '../config/vite.js';\nimport { cliVersion } from '../const.js';\nimport { isUnicodeSupported, Logger, randomBookSymbol } from '../logger.js';\nimport { createViteServer, getViewerFullUrl } from '../server.js';\n\nexport async function preview(inlineConfig: ParsedVivliostyleInlineConfig) {\n  Logger.setLogLevel(inlineConfig.logLevel);\n  Logger.setCustomLogger(inlineConfig.logger);\n  Logger.debug('preview > inlineConfig %O', inlineConfig);\n\n  let vivliostyleConfig =\n    (await loadVivliostyleConfig(inlineConfig)) ??\n    setupConfigFromFlags(inlineConfig);\n  warnDeprecatedConfig(vivliostyleConfig);\n  vivliostyleConfig = mergeInlineConfig(vivliostyleConfig, inlineConfig);\n  const { tasks, inlineOptions } = vivliostyleConfig;\n  Logger.debug('preview > vivliostyleConfig %O', vivliostyleConfig);\n\n  // Only show preview of first entry\n  let config = resolveTaskConfig(tasks[0], inlineOptions);\n  Logger.debug('preview > config %O', config);\n\n  let server: ViteDevServer;\n  let url: string;\n  {\n    using _ = Logger.startLogging('Start preview');\n    const viteConfig = await resolveViteConfig({\n      ...config,\n      mode: 'preview',\n    });\n    server = await createViteServer({\n      config,\n      viteConfig,\n      inlineConfig,\n      mode: 'preview',\n    });\n    if (server.httpServer) {\n      await server.listen();\n      vivliostyleConfig = mergeConfig(vivliostyleConfig, {\n        temporaryFilePrefix: config.temporaryFilePrefix,\n        server: server.config.server,\n      });\n      config = resolveTaskConfig(\n        vivliostyleConfig.tasks[0],\n        vivliostyleConfig.inlineOptions,\n      );\n    }\n    url = await getViewerFullUrl(config);\n  }\n\n  if (server.httpServer) {\n    Logger.log(`\n${cyan(`Vivliostyle CLI v${cliVersion}`)}\n${blueBright('║')} ${isUnicodeSupported ? `${randomBookSymbol} ` : ''}Up and running (press Ctrl+C to quit)\n${blueBright('╙─')} ${dim(`Preview URL: ${terminalLink(url, url, { fallback: () => url })}`)}\n`);\n  }\n  return server;\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,OAAO,kBAAkB;AAEzB,SAAS,YAAY,MAAM,WAAW;AAWtC,eAAsB,QAAQ,cAA6C;AACzE,SAAO,YAAY,aAAa,QAAQ;AACxC,SAAO,gBAAgB,aAAa,MAAM;AAC1C,SAAO,MAAM,6BAA6B,YAAY;AAEtD,MAAI,oBACD,MAAM,sBAAsB,YAAY,KACzC,qBAAqB,YAAY;AACnC,uBAAqB,iBAAiB;AACtC,sBAAoB,kBAAkB,mBAAmB,YAAY;AACrE,QAAM,EAAE,OAAO,cAAc,IAAI;AACjC,SAAO,MAAM,kCAAkC,iBAAiB;AAGhE,MAAI,SAAS,kBAAkB,MAAM,CAAC,GAAG,aAAa;AACtD,SAAO,MAAM,uBAAuB,MAAM;AAE1C,MAAI;AACJ,MAAI;AACJ;AACE;AAAA;AAAA,YAAMA,KAAI,uBAAO,aAAa,eAAe;AAC7C,YAAM,aAAa,MAAM,kBAAkB;AAAA,QACzC,GAAG;AAAA,QACH,MAAM;AAAA,MACR,CAAC;AACD,eAAS,MAAM,iBAAiB;AAAA,QAC9B;AAAA,QACA;AAAA,QACA;AAAA,QACA,MAAM;AAAA,MACR,CAAC;AACD,UAAI,OAAO,YAAY;AACrB,cAAM,OAAO,OAAO;AACpB,4BAAoB,YAAY,mBAAmB;AAAA,UACjD,qBAAqB,OAAO;AAAA,UAC5B,QAAQ,OAAO,OAAO;AAAA,QACxB,CAAC;AACD,iBAAS;AAAA,UACP,kBAAkB,MAAM,CAAC;AAAA,UACzB,kBAAkB;AAAA,QACpB;AAAA,MACF;AACA,YAAM,MAAM,iBAAiB,MAAM;AAAA,aAtBnC;AAAA;AAAA;AAAA;AAAA;AAAA,EAuBF;AAEA,MAAI,OAAO,YAAY;AACrB,WAAO,IAAI;AAAA,EACb,KAAK,oBAAoB,UAAU,EAAE,CAAC;AAAA,EACtC,WAAW,QAAG,CAAC,IAAI,qBAAqB,GAAG,gBAAgB,MAAM,EAAE;AAAA,EACnE,WAAW,cAAI,CAAC,IAAI,IAAI,gBAAgB,aAAa,KAAK,KAAK,EAAE,UAAU,MAAM,IAAI,CAAC,CAAC,EAAE,CAAC;AAAA,CAC3F;AAAA,EACC;AACA,SAAO;AACT;","names":["_"]}