{"version":3,"sources":["../src/config/vite.ts"],"sourcesContent":["import upath from 'upath';\nimport {\n  ConfigEnv,\n  createLogger,\n  InlineConfig,\n  mergeConfig as mergeViteConfig,\n  resolveConfig,\n  ResolvedConfig as ResolvedViteConfig,\n} from 'vite';\nimport { dim } from 'yoctocolors';\nimport { Logger } from '../logger.js';\nimport { useTmpDirectory } from '../util.js';\nimport { ResolvedTaskConfig } from './resolve.js';\n\n// Be careful not to confuse the preview/build commands of Vivliostyle CLI with Vite's mode.\n// In Vivliostyle CLI, \"preview\" command starts the dev server in Vite,\n// and \"build\" command starts the preview server in Vite.\nconst defaultConfigEnv: Record<'preview' | 'build', ConfigEnv> = {\n  preview: { command: 'serve', mode: 'development', isPreview: false },\n  build: { command: 'serve', mode: 'production', isPreview: true },\n};\n\nexport async function resolveViteConfig({\n  serverRootDir,\n  server,\n  viteConfig,\n  viteConfigFile,\n  logLevel,\n  workspaceDir,\n  mode,\n}: Pick<\n  ResolvedTaskConfig,\n  | 'serverRootDir'\n  | 'server'\n  | 'viteConfig'\n  | 'viteConfigFile'\n  | 'logLevel'\n  | 'workspaceDir'\n> & {\n  mode: 'preview' | 'build';\n}): Promise<ResolvedViteConfig> {\n  const viteLogger = createLogger(\n    (\n      {\n        silent: 'silent',\n        info: 'info',\n        verbose: 'info',\n        debug: 'info',\n      } as const\n    )[logLevel],\n    { allowClearScreen: false },\n  );\n  const warnedMessages = new Set<string>();\n  viteLogger.info = (msg) => {\n    Logger.logInfo(`${dim('[vite]')} ${msg}`);\n  };\n  viteLogger.warn = (msg) => {\n    viteLogger.hasWarned = true;\n    Logger.logWarn(`${dim('[vite]')} ${msg}`);\n  };\n  viteLogger.warnOnce = (msg) => {\n    if (warnedMessages.has(msg)) {\n      return;\n    }\n    viteLogger.hasWarned = true;\n    Logger.logWarn(`${dim('[vite]')} ${msg}`);\n    warnedMessages.add(msg);\n  };\n  viteLogger.error = (msg) => {\n    viteLogger.hasWarned = true;\n    Logger.logError(`${dim('[vite]')} ${msg}`);\n  };\n\n  const root =\n    typeof serverRootDir === 'string'\n      ? serverRootDir\n      : (await useTmpDirectory())[0];\n\n  const finalUserConfig = mergeViteConfig(viteConfig || {}, {\n    server,\n    preview: server,\n    configFile: viteConfigFile === true ? undefined : viteConfigFile,\n    root,\n    customLogger: viteLogger,\n    cacheDir: upath.join(workspaceDir, '.vite'),\n  } satisfies InlineConfig);\n  return await resolveConfig(\n    finalUserConfig,\n    defaultConfigEnv[mode].command,\n    defaultConfigEnv[mode].mode,\n    'development',\n    defaultConfigEnv[mode].isPreview,\n  );\n}\n"],"mappings":";;;;;;AAAA,OAAO,WAAW;AAClB;AAAA,EAEE;AAAA,EAEA,eAAe;AAAA,EACf;AAAA,OAEK;AACP,SAAS,WAAW;AAQpB,IAAM,mBAA2D;AAAA,EAC/D,SAAS,EAAE,SAAS,SAAS,MAAM,eAAe,WAAW,MAAM;AAAA,EACnE,OAAO,EAAE,SAAS,SAAS,MAAM,cAAc,WAAW,KAAK;AACjE;AAEA,eAAsB,kBAAkB;AAAA,EACtC;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF,GAUgC;AAC9B,QAAM,aAAa;AAAA,IAEf;AAAA,MACE,QAAQ;AAAA,MACR,MAAM;AAAA,MACN,SAAS;AAAA,MACT,OAAO;AAAA,IACT,EACA,QAAQ;AAAA,IACV,EAAE,kBAAkB,MAAM;AAAA,EAC5B;AACA,QAAM,iBAAiB,oBAAI,IAAY;AACvC,aAAW,OAAO,CAAC,QAAQ;AACzB,WAAO,QAAQ,GAAG,IAAI,QAAQ,CAAC,IAAI,GAAG,EAAE;AAAA,EAC1C;AACA,aAAW,OAAO,CAAC,QAAQ;AACzB,eAAW,YAAY;AACvB,WAAO,QAAQ,GAAG,IAAI,QAAQ,CAAC,IAAI,GAAG,EAAE;AAAA,EAC1C;AACA,aAAW,WAAW,CAAC,QAAQ;AAC7B,QAAI,eAAe,IAAI,GAAG,GAAG;AAC3B;AAAA,IACF;AACA,eAAW,YAAY;AACvB,WAAO,QAAQ,GAAG,IAAI,QAAQ,CAAC,IAAI,GAAG,EAAE;AACxC,mBAAe,IAAI,GAAG;AAAA,EACxB;AACA,aAAW,QAAQ,CAAC,QAAQ;AAC1B,eAAW,YAAY;AACvB,WAAO,SAAS,GAAG,IAAI,QAAQ,CAAC,IAAI,GAAG,EAAE;AAAA,EAC3C;AAEA,QAAM,OACJ,OAAO,kBAAkB,WACrB,iBACC,MAAM,gBAAgB,GAAG,CAAC;AAEjC,QAAM,kBAAkB,gBAAgB,cAAc,CAAC,GAAG;AAAA,IACxD;AAAA,IACA,SAAS;AAAA,IACT,YAAY,mBAAmB,OAAO,SAAY;AAAA,IAClD;AAAA,IACA,cAAc;AAAA,IACd,UAAU,MAAM,KAAK,cAAc,OAAO;AAAA,EAC5C,CAAwB;AACxB,SAAO,MAAM;AAAA,IACX;AAAA,IACA,iBAAiB,IAAI,EAAE;AAAA,IACvB,iBAAiB,IAAI,EAAE;AAAA,IACvB;AAAA,IACA,iBAAiB,IAAI,EAAE;AAAA,EACzB;AACF;","names":[]}